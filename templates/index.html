{% extends 'base.html' %}
{% block conteudo %}

<!-- Mensagens Flash (Popups) -->
{% with msg = get_flashed_messages()|first %}
{% if msg %}
<div id="flashPopup"
    class="fixed bottom-5 right-5 z-[1000] w-[16em] p-8 text-center bg-cor-fundo text-cor-principal border border-cor-secundaria rounded-[5px] shadow-[0_4px_8px_rgba(0,0,0,0.2)] transition-opacity duration-500 ease-in-out opacity-0 [&.show]:opacity-100">
    {{ msg }}
</div>
{% endif %}
{% endwith %}

<!-- Layout Principal -->
<div class="flex w-full justify-center md:justify-evenly bg-cor-fundo min-h-[80vh]">

    {% if 'user' in session %}
    <!-- Coluna Esquerda -->
    <div class="hidden md:block w-[20%] min-h-[80vh] bg-cor-fundo transition-colors duration-300">
    </div>
    {% endif %}

    <!-- Coluna Central (Feed) -->
    <div
        class="flex flex-col items-center justify-start w-full md:w-[60%] bg-cor-post border-x-0 md:border-x-2 border-cor-borda py-4 mt-4 md:mt-8 mb-8 rounded-none md:rounded-lg shadow-sm transition-colors duration-300 min-h-[80vh]">

        <!-- Formulário de Novo Post -->
        {% if 'user' in session %}
        <div
            class="flex flex-col justify-center items-center w-full p-4 mb-4 border-b-2 border-cor-borda bg-cor-post transition-colors">
            <form action="{{ '/editarpost/' + post.idPost|string if post else 'novopost' }}" method="post"
                class="w-[90%] md:w-[80%] flex flex-col justify-center gap-3">
                {% if 'user' in session %}
                <p class="text-center text-lg font-medium text-cor-texto-principal mb-2">Olá, <span
                        class="font-bold text-azul-purpura">{{session['user']}}</span>! O que deseja postar hoje?</p>
                {% endif %}
                <input type="text" name="titulo" placeholder="Título da Postagem"
                    value="{{ post.titulo if post else '' }}" required
                    class="w-full p-3 border border-cor-borda rounded-lg bg-cor-fundo text-cor-texto-principal focus:outline-none focus:border-cor-secundaria focus:ring-1 focus:ring-cor-secundaria transition-all hover:border-cor-secundaria placeholder-gray-400">
                <textarea name="conteudo" placeholder="Escreva aqui..." required rows="3"
                    class="w-full p-3 border border-cor-borda rounded-lg bg-cor-fundo text-cor-texto-principal resize-none focus:outline-none focus:border-cor-secundaria focus:ring-1 focus:ring-cor-secundaria transition-all hover:border-cor-secundaria placeholder-gray-400 font-sans">{{ post.conteudo if post else '' }}</textarea>
                <button type="submit"
                    class="w-[60%] self-center bg-cor-secundaria text-white py-2 px-4 rounded-md font-bold hover:bg-hover-cor-secundaria hover:opacity-90 transition-all duration-300 shadow-sm mt-2">{{'Salvar'
                    if post else 'Postar'}}</button>
            </form>
        </div>
        {% endif %}

        <!-- Área do Feed -->
        <div
            class="flex flex-col items-center justify-start w-full overflow-y-auto scrollbar-hide min-h-[65vh] px-2 md:px-4 pb-4 gap-4">

            <!-- Caso não haja posts -->
            {% if not postagens %}
            <div class="flex flex-col justify-center items-center gap-4 mt-10 opacity-70">
                <img src="{{ url_for('static', filename='img/fox.png') }}" alt="Sem posts"
                    class="w-[60%] max-w-[250px] opacity-80">
                <p class="text-xl text-cor-texto-secundaria text-center font-medium">Ainda não temos posts, <br>volte
                    mais tarde</p>
            </div>
            {% else %}

            <!-- Loop de Posts -->
            {% for post in postagens %}
            <div
                class="w-full md:w-[95%] bg-cor-post rounded-xl border border-cor-borda shadow-sm hover:shadow-md transition-shadow duration-300">

                <!-- Header do Post -->
                <div class="flex flex-row justify-between items-center p-4 border-b border-cor-borda">
                    <div class="flex flex-row gap-3 items-center">
                        <div class="flex justify-center items-center">
                            <img src="../static/uploads/{{post.fotoUsuario}}" alt="Avatar"
                                class="h-10 w-10 md:h-12 md:w-12 rounded-full object-cover border border-cor-borda">
                        </div>
                        <div class="p-5 text-cor-texto-principal">
                            <h2 class="text-zl mb:1 md:text-base font-bold text-cor-texto-principal">{{ post.user }}
                                <span class="font-normal text-cor-texto-secundaria">disse:</span>
                            </h2>
                            <p class="text-xs text-cor-texto-secundaria">{{ post.dataPost.strftime('%d/%m/%Y') }}</p>
                        </div>
                    </div>

                    <!-- Botão de Opções -->
                    {% if 'admin' in session or session.get('idUsuario') == post.idUsuario %}
                    <div class="relative flex items-center cursor-pointer group">
                        <div id="menuOptions-{{post.idPost}}"
                            class="hidden absolute right-0 top-8 bg-cor-post border border-cor-borda min-w-[160px] shadow-lg rounded-md z-10 overflow-hidden animate-fade-in-down">
                            {% if 'user' in session %}
                            <a href="/editarpost/{{post.idPost}}"
                                class="block px-4 py-3 text-sm text-cor-texto-principal hover:bg-cor-fundo transition-colors"><i
                                    class="fa-solid fa-pencil mr-2 text-azul-purpura"></i> Editar</a>
                            {% endif %}
                            <a href="/excluirpost/{{post.idPost}}"
                                class="block px-4 py-3 text-sm text-red-500 hover:bg-red-50 transition-colors"><i
                                    class="fa-solid fa-trash mr-2"></i> Excluir</a>
                        </div>
                        <div class="text-cor-texto-secundaria p-2 hover:text-cor-secundaria transition-colors text-lg"
                            onclick="toggleMenu('{{post.idPost}}')"><i class="fa-solid fa-ellipsis"></i></div>
                    </div>
                    {% endif %}
                </div>

                <!-- Conteúdo do Post -->
                <div class="p-5 text-cor-texto-principal">
                    <h2 class="text-xl font-bold text-azul-purpura leading-none mb-2">{{ post.titulo }}</h2>

                    {% set limite_char = 150 %}
                    {% set conteudo_completo = post.conteudo %}
                    {% set conteudo_truncado = post.conteudo | truncate(limite_char, killwords=False, end='') %}

                    <!-- Wrapper do texto com quebra de palavra e alinhamento -->
                    <div class="text-[15px] leading-relaxed break-words mt-0 text-gray-800">
                        {% if post.conteudo | length > limite_char %}
                        <!-- Texto Truncado + "..." -->
                        <span id="conteudo-truncado-{{ post.idPost }}">
                            {{ conteudo_truncado }}...
                        </span>

                        <!-- Texto Completo (Inicia Oculto) -->
                        <span id="conteudo-completo-{{ post.idPost }}" class="hidden">
                            {{ conteudo_completo }}
                        </span>

                        <!-- Botão Leia Mais (Inicia Visível e Inline) -->
                        <a href="#"
                            class="btn-toggle btn-leia-mais text-cor-secundaria font-semibold text-sm hover:underline hover:text-hover-cor-secundaria transition-colors ml-1 inline"
                            data-post-id="{{ post.idPost }}">Leia Mais...</a>

                        <!-- Botão Leia Menos (Inicia Oculto) -->
                        <a href="#"
                            class="btn-toggle btn-leia-menos hidden text-cor-texto-secundaria font-semibold text-sm hover:underline transition-colors ml-1"
                            id="btn-menos-{{ post.idPost }}" data-post-id="{{ post.idPost }}">Leia Menos...</a>
                        {% else %}
                        {{ post.conteudo }}
                        {% endif %}
                    </div>
                </div>

                <!-- Interação (Curtir/Comentar) -->
                {% if 'user' in session%}
                <div class="flex flex-col">
                    <hr class="border-t border-cor-borda w-full m-0">
                    <div class="flex flex-row justify-around items-center py-2 bg-cor-post/50">

                        <!-- Curtir -->
                        <div class="cursor-pointer py-2 px-4 rounded-md text-cor-texto-secundaria hover:bg-cor-fundo hover:text-cor-secundaria transition-colors duration-200 flex items-center gap-2 select-none group"
                            onclick="alternarCurtida('{{ post.idPost }}')">
                            <i id="icone-curtir-{{ post.idPost }}"
                                class="fa-regular fa-heart text-lg transition-all duration-200 [&.curtido]:text-red-600 [&.curtido]:font-bold [&.curtido]:fa-solid"></i>
                            <span
                                class="font-medium text-sm group-hover:text-cor-secundaria transition-colors">Amei</span>
                        </div>

                        <!-- Comentar -->
                        <div
                            class="cursor-pointer py-2 px-4 rounded-md text-cor-texto-secundaria hover:bg-cor-fundo hover:text-azul-purpura transition-colors duration-200 flex items-center gap-2 select-none">
                            <i class="fa-regular fa-comment text-lg"></i>
                            <span class="font-medium text-sm">Comentar</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% endif %}
        </div>
    </div>

    <!-- Coluna Direita -->
    <div class="hidden md:block w-[20%] min-h-[80vh] bg-cor-fundo transition-colors duration-300">
    </div>
</div>

<script>
    // Controle do Menu Dropdown (3 pontinhos)
    function toggleMenu(postId) {
        const menu = document.getElementById(`menuOptions-${postId}`);
        document.querySelectorAll('[id^="menuOptions-"]').forEach(el => {
            if (el.id !== `menuOptions-${postId}`) el.classList.add('hidden');
        });
        menu.classList.toggle('hidden');
    }

    // Fechar menu ao clicar fora
    window.addEventListener('click', function (e) {
        if (!e.target.closest('.group') && !e.target.closest('.fa-ellipsis')) {
            document.querySelectorAll('[id^="menuOptions-"]').forEach(el => {
                el.classList.add('hidden');
            });
        }
    });

    // Lógica do Leia Mais / Leia Menos
    document.addEventListener('DOMContentLoaded', function () {

        function togglePostContent(postId, showFull) {
            const truncado = document.getElementById(`conteudo-truncado-${postId}`);
            const completo = document.getElementById(`conteudo-completo-${postId}`);
            const btnMais = document.querySelector(`.btn-leia-mais[data-post-id="${postId}"]`);
            const btnMenos = document.getElementById(`btn-menos-${postId}`);

            if (truncado && completo && btnMais && btnMenos) {
                if (showFull) {
                    // Clicou em Leia Mais: Esconde truncado e botão mais, mostra completo e botão menos
                    truncado.classList.add('hidden');

                    completo.classList.remove('hidden');
                    completo.classList.add('inline'); // Força ficar na linha

                    btnMais.classList.remove('inline');
                    btnMais.classList.add('hidden');

                    btnMenos.classList.remove('hidden');
                    btnMenos.classList.add('inline'); // Força ficar na linha
                } else {
                    // Clicou em Leia Menos: Volta ao estado original
                    truncado.classList.remove('hidden');

                    completo.classList.remove('inline');
                    completo.classList.add('hidden');

                    btnMais.classList.remove('hidden');
                    btnMais.classList.add('inline');

                    btnMenos.classList.remove('inline');
                    btnMenos.classList.add('hidden');
                }
            }
        }

        const botoesToggle = document.querySelectorAll('.btn-toggle');
        botoesToggle.forEach(botao => {
            botao.addEventListener('click', function (event) {
                event.preventDefault();
                const postId = this.getAttribute('data-post-id');
                const isLeiaMais = this.classList.contains('btn-leia-mais');
                togglePostContent(postId, isLeiaMais);
            });
        });
    });
</script>

{% endblock %}